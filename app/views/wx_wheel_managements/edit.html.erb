<%= content_for :css do %>
    <%= stylesheet_link_tag 'widget/jquery.datetimepicker.css', 'data-turbolinks-track' => true %>
    <%= stylesheet_link_tag 'wx_shake_managements', 'data-turbolinks-track' => true %>
<% end %>
<%= content_for :content do %>
    <div class="col_main setup">
      <div class="main_hd">
        <h2>大转盘管理</h2>
        <div class="page_nav">
          <%= link_to '返回上一层', wx_wheel_managements_path, :class => 'icon_goback' %>
          <%= link_to '大转盘管理', wx_wheel_managements_path %>&nbsp;/&nbsp;编辑大转盘
        </div>
      </div>
      <div class="main_bd">
        <form>
            <div class="shake_meta">
              <div class="frm_control_group">
                <label for class="frm_label">活动名称</label>
                <div class="frm_controls">
                <span class="frm_input_box counter_in append ">
                  <input type="text" class="frm_input frm_msg_content" id="name" maxlength="35" value="<%= @wx_activity.name %>"/>
                </span>
                  <p class="frm_msg fail" style="display: none;">请输入活动名称</p>
                  <p class="frm_tips">活动名称只用于管理，不显示在下发的活动内容中</p>
                </div>
              </div>
            </div>
            <div class="shake_meta time_setting">
              <div class="frm_control_group">
                <label for class="frm_label">开始时间</label>
                <div class="frm_controls">
                  <div class="date_select timepicker">
                    <div class="datepicker_area">
                    <span class="btn datepicker_switch">
                      <input type="text" class="frm_input" id="datetimepicker_begin" value="<%= @wx_activity.begintime.strftime("%Y-%m-%d %H:%M") %>"/>
                      <i class="icon_datepicker"></i>
                    </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="shake_meta time_setting">
              <div class="frm_control_group">
                <label for class="frm_label">结束时间</label>
                <div class="frm_controls">
                  <div class="date_select timepicker">
                    <div class="datepicker_area">
                    <span class="btn datepicker_switch">
                      <input type="text" class="frm_input" id="datetimepicker_end" value="<%= @wx_activity.endtime.strftime("%Y-%m-%d %H:%M") %>"/>
                      <i class="icon_datepicker"></i>
                    </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="shake_meta">
              <div class="frm_control_group">
                <label for class="frm_label">抽奖限制</label>
                <div class="frm_controls">
                  <span>每人抽奖机会</span><span class="frm_input_box frm_small m_lr">
                  <input type="text" class="frm_input frm_msg_content" id="lottery_num" value="<%= @wx_activity.lottery_num %>"/></span><span>次</span>
                  <p><label class="radio-label"><input type="checkbox" name="" id="is_repeat_draw" >支持每天可重复抽奖</label></p>
                </div>
              </div>
            </div>
            <div class="shake_meta">
              <div class="frm_control_group">
                <label for class="frm_label">活动说明</label>
                <div class="frm_controls">
                  <div class="emotion_editor">
                    <textarea style="height:150px; width:740px;" maxlength="300"><%= @wx_activity.description %></textarea>
                    <div class="editor_toolbar"><div class="editor_tip">最多可以输入300字,按下Shift+Enter键换行</div></div>
                  </div>
                </div>
              </div>
            </div>
          <div class="shake_meta">
            <div class="frm_control_group">
              <label for class="frm_label">领奖方式</label>
              <div class="frm_controls">
                <label class="radio-label" id="j_mail">
                  <input type="radio" name="RadioGroup1" value="单选" id="RadioGroup1_0" />
                  邮寄/直接发放</label>
                <p class="frm_tips m_l20">用户中奖后通过表单来登记领奖信息。</p>
                <div id="j_mail_info" class="hide"><p class="frm_info m_l20"><label class="radio-label"><input type="checkbox" name="realname" id="" >姓名</label><label class="radio-label"><input type="checkbox" name="telephone" id="" >手机</label><label class="radio-label"><input type="checkbox" name="address" id="" >地址</label></p></div>
                <br />
                <label class="radio-label" id="j_offline">
                  <input type="radio" name="RadioGroup1" value="单选" id="RadioGroup1_1" />
                  线下兑奖</label>
                <div class="m_l20">
                  <p class="frm_tips">用户到线下兑奖，由商家进行核销。</p>
                  <div id="j_offline_info" class="hide"><br />
                    <p>是否需要中奖者填写信息<span class="frm_tips">(请勿要求填写与领奖无关的隐私信息）</span><br/><label class="radio-label" id="j_win" ><input type="checkbox" id="j_win_btn" >需要</label></p>
                    <p class="frm_info hide" id="j_win_info"><label class="radio-label"><input type="checkbox" name="realname" id="" >姓名</label><label class="radio-label"><input type="checkbox" name="telephone" id="" >手机</label></p><br />
                    <p>线下领奖地址<br/><span class="frm_input_box counter_in append ">
                        <input type="text" class="frm_input frm_msg_content" style="color:#8d8d8d"  onFocus="if(this.value=='请填写领奖地址'){this.value='';this.style.color='#8d8d8d'};" onblur="if(this.value==''){this.value='请填写领奖地址';this.style.color='#8d8d8d'}"  value="请填写领奖地址" />
                      </span></p><br/>
                    <p>线下领奖时间说明<br/><span class="frm_input_box counter_in append ">
                        <input type="text" class="frm_input frm_msg_content" style="color:#8d8d8d"  onFocus="if(this.value=='如：每天下午3:00~5:00'){this.value='';this.style.color='#8d8d8d'};" onblur="if(this.value==''){this.value='如：每天下午3:00~5:00';this.style.color='#8d8d8d'}"  value="如：每天下午3:00~5:00" />
                      </span></p></div>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div class="shake_meta">
          <span>奖项设置<span class="frm_tips">（上传图片的最佳尺寸：300像素*300像素，其他尺寸会影响页面效果，格式png，jpeg，jpg，gif。大小不超过1M）</span></span>
          <div class="shake_meta_container">
            <div class="shake_container_dec shake_add">
              <a class="btn btn_default btn_add btn_shake_add" href="javascript:;">添加奖项</a>
            </div>
            <div class="shake_container_dec shake_del">
              <a class="btn btn_default btn_del btn_shake_del" href="javascript:;">删除奖项</a>
            </div>
          </div>
        </div>
      </div>
      <div class="tool_bar tc" style="margin-top:60px;"><button class="btn btn_primary">完成</button></div>
    </div>
    <div class="results hide" style="position: fixed;left: 35%;top: 0;">删除成功</div>
<% end %>
<%= content_for :js do %>
    <%= javascript_include_tag 'activity/jquery.datetimepicker.full', 'data-turbolinks-track' => true %>
    <%= javascript_include_tag 'webuploader/webuploader.js', 'data-turbolinks-track' => true %>
    <%= javascript_include_tag 'wx_wheel_managements', 'data-turbolinks-track' => true %>

    <script type="text/javascript">
      $(function(){
        var wx_activity_awards = <%= raw @wx_activity_awards.to_json%>;
        $(wx_activity_awards).each(function(index) {
          var level = wx_activity_awards[index].level;
          var name = wx_activity_awards[index].name;
          var amount = wx_activity_awards[index].amount;
          var probability = wx_activity_awards[index].probability;
          var imgurl = wx_activity_awards[index].imgurl;
          var shake_num = null;
          switch(level)
          {
            case 1:
              shake_num = "一等奖";
              break;
            case 2:
              shake_num = "二等奖";
              break;
            case 3:
              shake_num = "三等奖";
              break;
            case 4:
              shake_num = "四等奖";
              break;
            case 5:
              shake_num = "五等奖";
              break;
          }
          var option_setting = $('<div class="shake_meta option_setting">' +
              '<form class="">' +
              '<div class="shake_meta_title group"><span class="shake_num">一等奖</span></div>' +
              '<div class="shake_meta shake_meta_content">' +
              '<div class="award">' +
              '<div class="shake_meta_detail"><div class="frm_control_group"><label for class="frm_label">奖品名称</label>' +
              '<div class="frm_controls"><span class="frm_input_box counter_in append "><input type="text" class="frm_input frm_msg_content" maxlength="35" /></span></div></div></div>' +
              '<div class="shake_meta_detail"><div class="frm_control_group"><label for class="frm_label" >数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量</label>' +
              '<div class="frm_controls"><span class="frm_input_box frm_small"><input type="text" class="frm_input frm_msg_content" /></span><span class="number_of">个</span></div></div>' +
              '<div class="frm_control_group"><label for class="frm_label" >概&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;率</label><div class="frm_controls"><span class="frm_input_box frm_small">' +
              '<input type="text" class="frm_input frm_msg_content" /></span><span class="number_of">%</span><span class="frm_tips">可设置范围（0.01%~100%）</span>' +
              '<p class="frm_tips">每次转动转盘后获得该奖品的概率，与该奖品数量无关</p></div></div></div>' +
              '<div class="prize_bar"><div id="filePicker">上传图片</div><div class="prize_img hide"><img src="" alt=""/><a href="javascript:;">删除</a></div></div></div>' +
              '</div></form></div>');
          option_setting.find('.shake_num').text(shake_num);
          option_setting.find('.frm_msg_content').eq(0).val(name);
          option_setting.find('.frm_msg_content').eq(1).val(amount);
          option_setting.find('.frm_msg_content').eq(2).val(probability);
          if (imgurl != "" && imgurl != null){
            option_setting.find('.prize_img img').attr('src',imgurl);
            option_setting.find('.prize_bar #filePicker').hide();
            option_setting.find('.prize_img').show();
          }
          option_setting.insertBefore($('.shake_container_dec.shake_add'));
        });

        picHandle();  // 上传图片事件初始化

        var wx_activity = <%= raw @wx_activity.to_json%>;
        if(wx_activity.is_repeat_draw){
          $('#is_repeat_draw').prop('checked','true');
        }
        if(wx_activity.receive_way == 0){
          $('#RadioGroup1_0').prop('checked','true');
          $("#j_mail_info").show();
          if(wx_activity.receive_info.indexOf('realname')!=-1){
            $("#j_mail_info input[name='realname']").prop('checked','true');
          }
          if(wx_activity.receive_info.indexOf('telephone')!=-1){
            $("#j_mail_info input[name='telephone']").prop('checked','true');
          }
          if(wx_activity.receive_info.indexOf('address')!=-1){
            $("#j_mail_info input[name='address']").prop('checked','true');
          }
        }else {
          $('#RadioGroup1_1').prop('checked','true');
          $("#j_offline_info").show();
          if(wx_activity.receive_info != null){
            $('#j_win_info').show();
            $('#j_win_btn').prop('checked','true');
            if(wx_activity.receive_info.indexOf('realname')!=-1){
              $("#j_win_info input[name='realname']").prop('checked','true');
            }
            if(wx_activity.receive_info.indexOf('telephone')!=-1){
              $("#j_win_info input[name='telephone']").prop('checked','true');
            }
            if(wx_activity.receive_info.indexOf('address')!=-1){
              $("#j_win_info input[name='address']").prop('checked','true');
            }
          }
          if(wx_activity.offline_address != null){
            $("#j_offline_info input[type='text']").eq(0).val(wx_activity.offline_address);
          }
          if(wx_activity.offline_description != null){
            $("#j_offline_info input[type='text']").eq(1).val(wx_activity.offline_description);
          }
        }

        $('.tc .btn_primary').click(function(){
          $.ajax({
            type: 'PATCH',
            url: '/wxoss/wx_wheel_managements/'+wx_activity.id,
            dataType: 'json',
            data: getWheelInfo(),
            success: function (data) {
              if (data.result == 'success') {
                msgShow("更新成功");
                document.location.href = '/wxoss/wx_wheel_managements/'+wx_activity.id;
              } else {
                msgShow("更新失败");
              }
            }
          });
        });
      });
    </script>

<% end %>